<!doctype html><html lang=en><head><title>Packer CentOS Virtualbox image ::
misctechmusings.com — notebook for projects, problems, and solution</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="SATA Wanted Many of the public CentOS Vagrant boxes are configured with only an IDE controller. I assume this is for compatibility reasons. The SATA controller on VirtualBox performs better, so that is what I want.
Serial ATA (SATA)
Like a real SATA controller, Oracle VM VirtualBox&amp;rsquo;s virtual SATA controller operates faster and also consumes fewer CPU resources than the virtual IDE controller. Also, this enables you to connect up to 30 virtual hard disks to one machine instead of just three, when compared to the Oracle VM VirtualBox IDE controller with a DVD drive attached."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://p0rkjello.github.io/packer-centos-virtualbox-image/><link rel=stylesheet href=https://p0rkjello.github.io/assets/style.css><link rel=stylesheet href=https://p0rkjello.github.io/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://p0rkjello.github.io/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://p0rkjello.github.io/img/favicon.png><link href=https://p0rkjello.github.io/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://p0rkjello.github.io/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://p0rkjello.github.io/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://p0rkjello.github.io/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://p0rkjello.github.io/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://p0rkjello.github.io/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="Packer CentOS Virtualbox image"><meta name=twitter:description content="SATA Wanted Many of the public CentOS Vagrant boxes are configured with only an IDE controller. I assume this is for compatibility reasons. The SATA controller on VirtualBox performs better, so that is what I want.
Serial ATA (SATA)
Like a real SATA controller, Oracle VM VirtualBox&rsquo;s virtual SATA controller operates faster and also consumes fewer CPU resources than the virtual IDE controller. Also, this enables you to connect up to 30 virtual hard disks to one machine instead of just three, when compared to the Oracle VM VirtualBox IDE controller with a DVD drive attached."><meta property="og:title" content="Packer CentOS Virtualbox image"><meta property="og:description" content="SATA Wanted Many of the public CentOS Vagrant boxes are configured with only an IDE controller. I assume this is for compatibility reasons. The SATA controller on VirtualBox performs better, so that is what I want.
Serial ATA (SATA)
Like a real SATA controller, Oracle VM VirtualBox&rsquo;s virtual SATA controller operates faster and also consumes fewer CPU resources than the virtual IDE controller. Also, this enables you to connect up to 30 virtual hard disks to one machine instead of just three, when compared to the Oracle VM VirtualBox IDE controller with a DVD drive attached."><meta property="og:type" content="article"><meta property="og:url" content="https://p0rkjello.github.io/packer-centos-virtualbox-image/"><meta property="article:section" content="posts"></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>/misc/tech/musings</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>About</a></li><li><a href=/archive>Archive</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>About</a></li><li><a href=/archive>Archive</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>Packer CentOS Virtualbox image</h1><div class=post-meta><span class=post-author>— Written by Andrew Bounds</span></div><span class=post-tags><a href=https://p0rkjello.github.io/tags/linux/>#linux</a>&nbsp;
<a href=https://p0rkjello.github.io/tags/packer/>#packer</a>&nbsp;
<a href=https://p0rkjello.github.io/tags/virtualbox/>#virtualbox</a>&nbsp;
<a href=https://p0rkjello.github.io/tags/vagrant/>#vagrant</a>&nbsp;</span><div class=post-content><h2 id=sata-wanted>SATA Wanted</h2><p>Many of the public CentOS <a href=https://app.vagrantup.com/boxes/search>Vagrant boxes</a> are configured with only an IDE controller. I assume this is for compatibility reasons. The SATA controller on VirtualBox performs better, so that is what I want.</p><p><strong><a href=https://www.virtualbox.org/manual/ch05.html#harddiskcontrollers>Serial ATA (SATA)</a></strong></p><blockquote><p>Like a real SATA controller, Oracle VM VirtualBox&rsquo;s virtual SATA controller operates faster and also consumes fewer CPU resources than the virtual IDE controller. Also, this enables you to connect up to 30 virtual hard disks to one machine instead of just three, when compared to the Oracle VM VirtualBox IDE controller with a DVD drive attached.</p></blockquote><h2 id=getting-started>Getting started</h2><p>To start the process of building your Vagrant box using Packer, create a working directory. Within that directory create the <a href=#packer-json-file>Packer template</a>. The Packer template, which I named <code>centos-7.7-x86_64.json</code>, is a file that describes how to build the image.</p><h2 id=packer-template>Packer Template</h2><p>Within the <code>JSON</code> file we define the builder type <a href=https://www.packer.io/docs/builders/virtualbox-iso.html>virtualbox-iso</a>. This builder will create a new image from an ISO file. Here is where we can define the <strong>hard_drive_interface</strong> as SCSI.</p><blockquote><p>hard_drive_interface (string) - The type of controller that the primary hard drive is attached to, defaults to ide. When set to sata, the drive is attached to an AHCI SATA controller. When set to scsi, the drive is attached to an LsiLogic SCSI controller.</p></blockquote><h3 id=centos-77-x86_64json>centos-7.7-x86_64.json</h3><p>The information about the Packer template configuration options are detailed in the <a href=https://www.packer.io/docs/index.html>docs</a>.</p><p>{% raw %}</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;builders&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;virtualbox-iso&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;guest_os_type&#34;</span>: <span style=color:#e6db74>&#34;RedHat_64&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;iso_url&#34;</span>: <span style=color:#e6db74>&#34;{{user `mirror`}}/7/isos/x86_64/CentOS-7-x86_64-NetInstall-1908.iso&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;iso_checksum&#34;</span>: <span style=color:#e6db74>&#34;{{user `iso_checksum`}}&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;iso_checksum_type&#34;</span>: <span style=color:#e6db74>&#34;{{user `iso_checksum_type`}}&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;output_directory&#34;</span>: <span style=color:#e6db74>&#34;output-centos-7.7-x86_64-{{build_type}}&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;vm_name&#34;</span>: <span style=color:#e6db74>&#34;packer-centos-7.7-x86_64&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;disk_size&#34;</span>: <span style=color:#e6db74>&#34;{{user `disk_size`}}&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;hard_drive_discard&#34;</span>: <span style=color:#e6db74>&#34;{{user `hard_drive_discard`}}&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;hard_drive_nonrotational&#34;</span>: <span style=color:#e6db74>&#34;{{user `hard_drive_nonrotational`}}&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;headless&#34;</span>: <span style=color:#e6db74>&#34;{{user `headless`}}&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;hard_drive_interface&#34;</span>: <span style=color:#e6db74>&#34;{{user `hard_drive_interface`}}&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;http_directory&#34;</span>: <span style=color:#e6db74>&#34;http&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;boot_wait&#34;</span>: <span style=color:#e6db74>&#34;5s&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;boot_command&#34;</span>: [
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;&lt;esc&gt;&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;&lt;wait&gt;&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;linux inst.ks=http://{{.HTTPIP}}:{{.HTTPPort}}/ks.cfg biosdevname=0 net.ifnames=0&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;&lt;enter&gt;&#34;</span>
</span></span><span style=display:flex><span>      ],
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;ssh_timeout&#34;</span>: <span style=color:#e6db74>&#34;{{user `ssh_timeout`}}&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;ssh_username&#34;</span>: <span style=color:#e6db74>&#34;vagrant&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;ssh_password&#34;</span>: <span style=color:#e6db74>&#34;vagrant&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;ssh_pty&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;shutdown_command&#34;</span>: <span style=color:#e6db74>&#34;sudo systemctl poweroff&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;vboxmanage&#34;</span>: [
</span></span><span style=display:flex><span>        [<span style=color:#e6db74>&#34;modifyvm&#34;</span>, <span style=color:#e6db74>&#34;{{.Name}}&#34;</span>, <span style=color:#e6db74>&#34;--memory&#34;</span>, <span style=color:#e6db74>&#34;{{user `memory`}}&#34;</span>],
</span></span><span style=display:flex><span>        [<span style=color:#e6db74>&#34;modifyvm&#34;</span>, <span style=color:#e6db74>&#34;{{.Name}}&#34;</span>, <span style=color:#e6db74>&#34;--cpus&#34;</span>, <span style=color:#e6db74>&#34;{{user `cpus`}}&#34;</span>],
</span></span><span style=display:flex><span>        [<span style=color:#e6db74>&#34;modifyvm&#34;</span>, <span style=color:#e6db74>&#34;{{.Name}}&#34;</span>, <span style=color:#e6db74>&#34;--nic1&#34;</span>, <span style=color:#e6db74>&#34;nat&#34;</span>, <span style=color:#e6db74>&#34;--nictype1&#34;</span>, <span style=color:#e6db74>&#34;virtio&#34;</span>]
</span></span><span style=display:flex><span>      ]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ],
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;provisioners&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;shell&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;scripts&#34;</span>: [
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;scripts/sshd.sh&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;scripts/virtualbox.sh&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;scripts/cleanup.sh&#34;</span>
</span></span><span style=display:flex><span>      ]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ],
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;post-processors&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;vagrant&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;compression_level&#34;</span>: <span style=color:#e6db74>&#34;{{user `compression_level`}}&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;output&#34;</span>: <span style=color:#e6db74>&#34;centos-7.7-x86_64-{{.Provider}}.box&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ],
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;variables&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;compression_level&#34;</span>: <span style=color:#e6db74>&#34;6&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;cpus&#34;</span>: <span style=color:#e6db74>&#34;1&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;disk_size&#34;</span>: <span style=color:#e6db74>&#34;8000&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;hard_drive_discard&#34;</span>: <span style=color:#e6db74>&#34;true&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;hard_drive_interface&#34;</span>: <span style=color:#e6db74>&#34;sata&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;hard_drive_nonrotational&#34;</span>: <span style=color:#e6db74>&#34;true&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;headless&#34;</span>: <span style=color:#e6db74>&#34;true&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;iso_checksum&#34;</span>: <span style=color:#e6db74>&#34;6ffa7ad44e8716e4cd6a5c3a85ba5675a935fc0448c260f43b12311356ba85ad&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;iso_checksum_type&#34;</span>: <span style=color:#e6db74>&#34;sha256&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;memory&#34;</span>: <span style=color:#e6db74>&#34;512&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;mirror&#34;</span>: <span style=color:#e6db74>&#34;http://mirror.lug.udel.edu/pub/centos&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;ssh_timeout&#34;</span>: <span style=color:#e6db74>&#34;60m&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>{% endraw %}</p><p>Validate the contents of the json file <code>packer validate &lt;template></code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>➜  packer validate .\centos-7.7-x86_64.json
</span></span><span style=display:flex><span>Template validated successfully.
</span></span></code></pre></div><h2 id=centos-kickstart-file>CentOS kickstart file</h2><p><a href=https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/installation_guide/sect-kickstart-syntax>Documentation</a> and <a href=https://github.com/CentOS/Community-Kickstarts>example</a> kickstart files can be found online. This file will install CentOS with configuration to fit my needs.</p><ul><li>Install a minimal set of packages</li><li>Disable firewall and SELinux</li><li>Add and configure the Vagrant user</li></ul><p><strong>Warning</strong>: Recommended for local development and lab use only. This kickstart file is insecure by default.
{: .flash .flash-warn }</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-conf data-lang=conf><span style=display:flex><span><span style=color:#75715e># RHEL7 - Vagrant lab system
</span></span></span><span style=display:flex><span><span style=color:#75715e># Install OS instead of upgrade
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>install
</span></span><span style=display:flex><span><span style=color:#75715e># Keyboard layouts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>keyboard <span style=color:#960050;background-color:#1e0010>&#39;</span>us<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># After installation reboot
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>reboot
</span></span><span style=display:flex><span><span style=color:#75715e># Root password
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>rootpw --plaintext vagrant
</span></span><span style=display:flex><span><span style=color:#75715e># Use text mode install
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>text
</span></span><span style=display:flex><span>firstboot --disable
</span></span><span style=display:flex><span><span style=color:#75715e># Setup network interface
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>network --device<span style=color:#f92672>=</span>eth0 --bootproto<span style=color:#f92672>=</span>dhcp --onboot<span style=color:#f92672>=</span>yes --activate
</span></span><span style=display:flex><span><span style=color:#75715e># Install from an installation tree on a remote server
</span></span></span><span style=display:flex><span><span style=color:#75715e># Required when using a miniml ISO
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>url --mirrorlist<span style=color:#f92672>=</span>http<span style=color:#960050;background-color:#1e0010>://</span>mirrorlist.centos.org<span style=color:#960050;background-color:#1e0010>/?</span>release<span style=color:#f92672>=</span><span style=color:#960050;background-color:#1e0010>$</span>releasever<span style=color:#960050;background-color:#1e0010>&amp;</span>arch<span style=color:#f92672>=</span><span style=color:#960050;background-color:#1e0010>$</span>basearch<span style=color:#960050;background-color:#1e0010>&amp;</span>repo<span style=color:#f92672>=</span>os
</span></span><span style=display:flex><span><span style=color:#75715e># Set repo to mirror.centos.org
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>repo --name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;CentOS&#34;</span> --baseurl<span style=color:#f92672>=</span>http<span style=color:#960050;background-color:#1e0010>://</span>mirror.centos.org<span style=color:#960050;background-color:#1e0010>/</span>centos<span style=color:#960050;background-color:#1e0010>/$</span>releasever<span style=color:#960050;background-color:#1e0010>/</span>os<span style=color:#960050;background-color:#1e0010>/$</span>basearch<span style=color:#960050;background-color:#1e0010>/</span> --cost<span style=color:#f92672>=</span>100
</span></span><span style=display:flex><span>repo --name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Updates&#34;</span> --baseurl<span style=color:#f92672>=</span>http<span style=color:#960050;background-color:#1e0010>://</span>mirror.centos.org<span style=color:#960050;background-color:#1e0010>/</span>centos<span style=color:#960050;background-color:#1e0010>/$</span>releasever<span style=color:#960050;background-color:#1e0010>/</span>updates<span style=color:#960050;background-color:#1e0010>/$</span>basearch<span style=color:#960050;background-color:#1e0010>/</span> --cost<span style=color:#f92672>=</span>100
</span></span><span style=display:flex><span>repo --name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;epel&#34;</span> --baseurl<span style=color:#f92672>=</span>https<span style=color:#960050;background-color:#1e0010>://</span>download.fedoraproject.org<span style=color:#960050;background-color:#1e0010>/</span>pub<span style=color:#960050;background-color:#1e0010>/</span>epel<span style=color:#960050;background-color:#1e0010>/</span>7<span style=color:#960050;background-color:#1e0010>/</span>x86_64<span style=color:#960050;background-color:#1e0010>/</span> --cost<span style=color:#f92672>=</span>100
</span></span><span style=display:flex><span><span style=color:#75715e># System language
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>lang en_US.UTF-8
</span></span><span style=display:flex><span><span style=color:#75715e># Logging
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>logging --level<span style=color:#f92672>=</span>debug
</span></span><span style=display:flex><span><span style=color:#75715e># System timezone
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>timezone --utc Etc<span style=color:#960050;background-color:#1e0010>/</span>UTC
</span></span><span style=display:flex><span><span style=color:#75715e># Firewall
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>firewall --disable
</span></span><span style=display:flex><span><span style=color:#75715e># SELinux
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>selinux --permissive
</span></span><span style=display:flex><span><span style=color:#75715e># Accept EULA
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>eula --agreed
</span></span><span style=display:flex><span><span style=color:#75715e># Services
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>services --enabled<span style=color:#f92672>=</span>ntpd,ntpdate
</span></span><span style=display:flex><span><span style=color:#75715e># Add Vagrant user
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>user --name<span style=color:#f92672>=</span>vagrant --plaintext  --password<span style=color:#f92672>=</span>vagrant --groups<span style=color:#f92672>=</span>vagrant,wheel
</span></span><span style=display:flex><span><span style=color:#75715e># System bootloader configuration
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>bootloader --location<span style=color:#f92672>=</span>mbr
</span></span><span style=display:flex><span><span style=color:#75715e># Clear the Master Boot Record
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>zerombr
</span></span><span style=display:flex><span><span style=color:#75715e># Partition clearing information
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>clearpart --all --initlabel
</span></span><span style=display:flex><span><span style=color:#75715e># Automatically create partition, LVM
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>autopart --type<span style=color:#f92672>=</span>lvm
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>%</span>packages --ignoremissing --excludedocs
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>@</span>core
</span></span><span style=display:flex><span>epel-release
</span></span><span style=display:flex><span>dkms
</span></span><span style=display:flex><span>kernel-devel
</span></span><span style=display:flex><span>kernel-headers
</span></span><span style=display:flex><span>make
</span></span><span style=display:flex><span>automake
</span></span><span style=display:flex><span>perl
</span></span><span style=display:flex><span>gcc
</span></span><span style=display:flex><span>gcc-c<span style=color:#960050;background-color:#1e0010>++</span>
</span></span><span style=display:flex><span>bzip2
</span></span><span style=display:flex><span>which
</span></span><span style=display:flex><span>wget
</span></span><span style=display:flex><span>ntp
</span></span><span style=display:flex><span>ntpdate
</span></span><span style=display:flex><span><span style=color:#75715e># mandatory packages in the @core group
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>-btrfs-progs
</span></span><span style=display:flex><span>-iprutils
</span></span><span style=display:flex><span>-kexec-tools
</span></span><span style=display:flex><span>-plymouth
</span></span><span style=display:flex><span><span style=color:#75715e># default packages in the @core group
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>-<span style=color:#960050;background-color:#1e0010>*</span>-firmware
</span></span><span style=display:flex><span>-dracut-config-rescue
</span></span><span style=display:flex><span>-kernel-tools
</span></span><span style=display:flex><span>-libsysfs
</span></span><span style=display:flex><span>-microcode_ctl
</span></span><span style=display:flex><span>-NetworkManager<span style=color:#960050;background-color:#1e0010>*</span>
</span></span><span style=display:flex><span>-postfix
</span></span><span style=display:flex><span>-rdma
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>%</span>end
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>%</span>post
</span></span><span style=display:flex><span><span style=color:#75715e># Apply Vagrant public key.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>echo <span style=color:#e6db74>&#34;Applying Vagrant public key&#34;</span>
</span></span><span style=display:flex><span>sudo mkdir -p <span style=color:#960050;background-color:#1e0010>/</span>home<span style=color:#960050;background-color:#1e0010>/</span>vagrant<span style=color:#960050;background-color:#1e0010>/</span>.ssh
</span></span><span style=display:flex><span>sudo curl -fsSLo <span style=color:#960050;background-color:#1e0010>/</span>home<span style=color:#960050;background-color:#1e0010>/</span>vagrant<span style=color:#960050;background-color:#1e0010>/</span>.ssh<span style=color:#960050;background-color:#1e0010>/</span>authorized_keys https<span style=color:#960050;background-color:#1e0010>://</span>raw.githubusercontent.com<span style=color:#960050;background-color:#1e0010>/</span>hashicorp<span style=color:#960050;background-color:#1e0010>/</span>vagrant<span style=color:#960050;background-color:#1e0010>/</span>master<span style=color:#960050;background-color:#1e0010>/</span>keys<span style=color:#960050;background-color:#1e0010>/</span>vagrant.pub
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Change owner and group on SSH authorized keys file for vagrant user
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>sudo chown -R vagrant<span style=color:#960050;background-color:#1e0010>:</span>vagrant <span style=color:#960050;background-color:#1e0010>/</span>home<span style=color:#960050;background-color:#1e0010>/</span>vagrant<span style=color:#960050;background-color:#1e0010>/</span>.ssh
</span></span><span style=display:flex><span>sudo chmod 700 <span style=color:#960050;background-color:#1e0010>/</span>home<span style=color:#960050;background-color:#1e0010>/</span>vagrant<span style=color:#960050;background-color:#1e0010>/</span>.ssh
</span></span><span style=display:flex><span>sudo chmod 600 <span style=color:#960050;background-color:#1e0010>/</span>home<span style=color:#960050;background-color:#1e0010>/</span>vagrant<span style=color:#960050;background-color:#1e0010>/</span>.ssh<span style=color:#960050;background-color:#1e0010>/</span>authorized_keys
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Configure Vagrant for no password sudo
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>echo <span style=color:#e6db74>&#34;Configuring Vagrant for passwordless sudo&#34;</span>
</span></span><span style=display:flex><span>sudo cat <span style=color:#960050;background-color:#1e0010>&gt;</span> <span style=color:#960050;background-color:#1e0010>/</span>etc<span style=color:#960050;background-color:#1e0010>/</span>sudoers.d<span style=color:#960050;background-color:#1e0010>/</span>vagrant <span style=color:#960050;background-color:#1e0010>&lt;&lt;&#39;</span>EOF<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>Defaults<span style=color:#960050;background-color:#1e0010>:</span>vagrant <span style=color:#960050;background-color:#1e0010>!</span>requiretty
</span></span><span style=display:flex><span>vagrant ALL<span style=color:#f92672>=</span><span style=color:#960050;background-color:#1e0010>(</span>ALL) NOPASSWD<span style=color:#960050;background-color:#1e0010>:</span> ALL
</span></span><span style=display:flex><span>EOF
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Change permissions on vagrant sudo file
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>sudo chmod 440 <span style=color:#960050;background-color:#1e0010>/</span>etc<span style=color:#960050;background-color:#1e0010>/</span>sudoers.d<span style=color:#960050;background-color:#1e0010>/</span>vagrant
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>%</span>end
</span></span></code></pre></div><h2 id=project-directory>Project directory</h2><p>The project directory should resemble the outline below.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>📦centos-packer-virtualbox
</span></span><span style=display:flex><span> ┃ ┣ 📂http
</span></span><span style=display:flex><span> ┃ ┗ 📜ks.cfg
</span></span><span style=display:flex><span> ┣ 📂scripts
</span></span><span style=display:flex><span> ┃ ┣ 📜cleanup.sh
</span></span><span style=display:flex><span> ┃ ┣ 📜sshd.sh
</span></span><span style=display:flex><span> ┃ ┗ 📜virtualbox.sh
</span></span><span style=display:flex><span> ┣ 📜.gitignore
</span></span><span style=display:flex><span> ┗ 📜centos-7.7-x86_64.json
</span></span></code></pre></div><h2 id=building-the-box>Building the box</h2><p>Once everything is in place run <code>packer build &lt;template></code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>➜  packer build centos-7.7-x86_64.json
</span></span><span style=display:flex><span>virtualbox-iso output will be in this color.
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>...
</span></span><span style=display:flex><span>truncated output
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>==&gt; virtualbox-iso: Running post-processor: vagrant
</span></span><span style=display:flex><span>==&gt; virtualbox-iso (vagrant): Creating Vagrant box for &#39;virtualbox&#39; provider
</span></span><span style=display:flex><span>    virtualbox-iso (vagrant): Copying from artifact: output-centos-7.7-x86_64-virtualbox-iso\packer-centos-7.7-x86_64-disk001.vmdk
</span></span><span style=display:flex><span>    virtualbox-iso (vagrant): Copying from artifact: output-centos-7.7-x86_64-virtualbox-iso\packer-centos-7.7-x86_64.ovf
</span></span><span style=display:flex><span>    virtualbox-iso (vagrant): Renaming the OVF to box.ovf...
</span></span><span style=display:flex><span>    virtualbox-iso (vagrant): Compressing: Vagrantfile
</span></span><span style=display:flex><span>    virtualbox-iso (vagrant): Compressing: box.ovf
</span></span><span style=display:flex><span>    virtualbox-iso (vagrant): Compressing: metadata.json
</span></span><span style=display:flex><span>    virtualbox-iso (vagrant): Compressing: packer-centos-7.7-x86_64-disk001.vmdk
</span></span><span style=display:flex><span>Build &#39;virtualbox-iso&#39; finished.
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>==&gt; Builds finished. The artifacts of successful builds are:
</span></span><span style=display:flex><span>--&gt; virtualbox-iso: &#39;virtualbox&#39; provider box: centos-7.7-x86_64-virtualbox.box
</span></span></code></pre></div><h2 id=gitignore>.gitignore</h2><p>The <code>packer_cache</code> directory contains the ISO files used for building the image. The <code>*.box</code> file is the output image. These are large files that do not need to be tracked via Git. It&rsquo;s recommended to exclude these items in your <code>.gitignore</code> file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-conf data-lang=conf><span style=display:flex><span><span style=color:#75715e># Cache objects
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>packer_cache<span style=color:#960050;background-color:#1e0010>/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># For built boxes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>*</span>.box
</span></span></code></pre></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://p0rkjello.github.io/network-bonding/><span class=button__icon>←</span>
<span class=button__text>Network Bonding</span></a></span>
<span class="button next"><a href=https://p0rkjello.github.io/persistent-gnome-shell-in-lucid/><span class=button__text>Persistent Gnome shell in Lucid</span>
<span class=button__icon>→</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>/misc/tech/musings</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2023 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=https://p0rkjello.github.io/assets/main.js></script>
<script src=https://p0rkjello.github.io/assets/prism.js></script></div></body></html>