<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        Packer CentOS Virtualbox image ::
        misctechmusings.com ‚Äî notebook for projects, problems, and solution
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="SATA Wanted Many of the public CentOS Vagrant boxes are configured with only an IDE controller. I assume this is for compatibility reasons. The SATA controller on VirtualBox performs better, so that is what I want.
Serial ATA (SATA)
 Like a real SATA controller, Oracle VM VirtualBox&amp;rsquo;s virtual SATA controller operates faster and also consumes fewer CPU resources than the virtual IDE controller. Also, this enables you to connect up to 30 virtual hard disks to one machine instead of just three, when compared to the Oracle VM VirtualBox IDE controller with a DVD drive attached."
/>
<meta
  name="keywords"
  content=""
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="/packer-centos-virtualbox-image/" />





<link rel="stylesheet" href="/assets/style.css" />

<link rel="stylesheet" href="/style.css" />


<link
  rel="apple-touch-icon-precomposed"
  sizes="144x144"
  href="/img/apple-touch-icon-144-precomposed.png"
/>
<link rel="shortcut icon" href="/img/favicon.png" />


<link href="/assets/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Packer CentOS Virtualbox image"/>
<meta name="twitter:description" content="SATA Wanted Many of the public CentOS Vagrant boxes are configured with only an IDE controller. I assume this is for compatibility reasons. The SATA controller on VirtualBox performs better, so that is what I want.
Serial ATA (SATA)
 Like a real SATA controller, Oracle VM VirtualBox&rsquo;s virtual SATA controller operates faster and also consumes fewer CPU resources than the virtual IDE controller. Also, this enables you to connect up to 30 virtual hard disks to one machine instead of just three, when compared to the Oracle VM VirtualBox IDE controller with a DVD drive attached."/>



<meta property="og:title" content="Packer CentOS Virtualbox image" />
<meta property="og:description" content="SATA Wanted Many of the public CentOS Vagrant boxes are configured with only an IDE controller. I assume this is for compatibility reasons. The SATA controller on VirtualBox performs better, so that is what I want.
Serial ATA (SATA)
 Like a real SATA controller, Oracle VM VirtualBox&rsquo;s virtual SATA controller operates faster and also consumes fewer CPU resources than the virtual IDE controller. Also, this enables you to connect up to 30 virtual hard disks to one machine instead of just three, when compared to the Oracle VM VirtualBox IDE controller with a DVD drive attached." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/packer-centos-virtualbox-image/" /><meta property="article:section" content="posts" />

<meta property="og:site_name" content="misctechmusings.com" />







  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >/misc/tech/musings</span
    >
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="/archive">Archive</a></li>
        
      
      
      
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
      
        <li><a href="/archive">Archive</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title">Packer CentOS Virtualbox image</h1>
    <div class="post-meta">
      

      
        <span class="post-author"
          >‚Äî Written by Andrew Bounds</span
        >


      
    </div>

    
      <span class="post-tags">
        
          <a href="/tags/linux/">#linux</a>&nbsp;
        
          <a href="/tags/packer/">#packer</a>&nbsp;
        
          <a href="/tags/virtualbox/">#virtualbox</a>&nbsp;
        
          <a href="/tags/vagrant/">#vagrant</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      
      <h2 id="sata-wanted">SATA Wanted</h2>
<p>Many of the public CentOS <a href="https://app.vagrantup.com/boxes/search">Vagrant boxes</a> are configured with only an IDE controller. I assume this is for compatibility reasons. The SATA controller on VirtualBox performs better, so that is what I want.</p>
<p><strong><a href="https://www.virtualbox.org/manual/ch05.html#harddiskcontrollers">Serial ATA (SATA)</a></strong></p>
<blockquote>
<p>Like a real SATA controller, Oracle VM VirtualBox&rsquo;s virtual SATA controller operates faster and also consumes fewer CPU resources than the virtual IDE controller. Also, this enables you to connect up to 30 virtual hard disks to one machine instead of just three, when compared to the Oracle VM VirtualBox IDE controller with a DVD drive attached.</p>
</blockquote>
<h2 id="getting-started">Getting started</h2>
<p>To start the process of building your Vagrant box using Packer, create a working directory. Within that directory create the <a href="#packer-json-file">Packer template</a>. The Packer template, which I named <code>centos-7.7-x86_64.json</code>, is a file that describes how to build the image.</p>
<h2 id="packer-template">Packer Template</h2>
<p>Within the <code>JSON</code> file we define the builder type <a href="https://www.packer.io/docs/builders/virtualbox-iso.html">virtualbox-iso</a>. This builder will create a new image from an ISO file. Here is where we can define the <strong>hard_drive_interface</strong> as SCSI.</p>
<blockquote>
<p>hard_drive_interface (string) - The type of controller that the primary hard drive is attached to, defaults to ide. When set to sata, the drive is attached to an AHCI SATA controller. When set to scsi, the drive is attached to an LsiLogic SCSI controller.</p>
</blockquote>
<h3 id="centos-77-x86_64json">centos-7.7-x86_64.json</h3>
<p>The information about the Packer template configuration options are detailed in the <a href="https://www.packer.io/docs/index.html">docs</a>.</p>
<p>{% raw %}</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;builders&#34;</span>: [
    {
      <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;virtualbox-iso&#34;</span>,
      <span style="color:#f92672">&#34;guest_os_type&#34;</span>: <span style="color:#e6db74">&#34;RedHat_64&#34;</span>,
      <span style="color:#f92672">&#34;iso_url&#34;</span>: <span style="color:#e6db74">&#34;{{user `mirror`}}/7/isos/x86_64/CentOS-7-x86_64-NetInstall-1908.iso&#34;</span>,
      <span style="color:#f92672">&#34;iso_checksum&#34;</span>: <span style="color:#e6db74">&#34;{{user `iso_checksum`}}&#34;</span>,
      <span style="color:#f92672">&#34;iso_checksum_type&#34;</span>: <span style="color:#e6db74">&#34;{{user `iso_checksum_type`}}&#34;</span>,
      <span style="color:#f92672">&#34;output_directory&#34;</span>: <span style="color:#e6db74">&#34;output-centos-7.7-x86_64-{{build_type}}&#34;</span>,
      <span style="color:#f92672">&#34;vm_name&#34;</span>: <span style="color:#e6db74">&#34;packer-centos-7.7-x86_64&#34;</span>,
      <span style="color:#f92672">&#34;disk_size&#34;</span>: <span style="color:#e6db74">&#34;{{user `disk_size`}}&#34;</span>,
      <span style="color:#f92672">&#34;hard_drive_discard&#34;</span>: <span style="color:#e6db74">&#34;{{user `hard_drive_discard`}}&#34;</span>,
      <span style="color:#f92672">&#34;hard_drive_nonrotational&#34;</span>: <span style="color:#e6db74">&#34;{{user `hard_drive_nonrotational`}}&#34;</span>,
      <span style="color:#f92672">&#34;headless&#34;</span>: <span style="color:#e6db74">&#34;{{user `headless`}}&#34;</span>,
      <span style="color:#f92672">&#34;hard_drive_interface&#34;</span>: <span style="color:#e6db74">&#34;{{user `hard_drive_interface`}}&#34;</span>,
      <span style="color:#f92672">&#34;http_directory&#34;</span>: <span style="color:#e6db74">&#34;http&#34;</span>,
      <span style="color:#f92672">&#34;boot_wait&#34;</span>: <span style="color:#e6db74">&#34;5s&#34;</span>,
      <span style="color:#f92672">&#34;boot_command&#34;</span>: [
        <span style="color:#e6db74">&#34;&lt;esc&gt;&#34;</span>,
        <span style="color:#e6db74">&#34;&lt;wait&gt;&#34;</span>,
        <span style="color:#e6db74">&#34;linux inst.ks=http://{{.HTTPIP}}:{{.HTTPPort}}/ks.cfg biosdevname=0 net.ifnames=0&#34;</span>,
        <span style="color:#e6db74">&#34;&lt;enter&gt;&#34;</span>
      ],
      <span style="color:#f92672">&#34;ssh_timeout&#34;</span>: <span style="color:#e6db74">&#34;{{user `ssh_timeout`}}&#34;</span>,
      <span style="color:#f92672">&#34;ssh_username&#34;</span>: <span style="color:#e6db74">&#34;vagrant&#34;</span>,
      <span style="color:#f92672">&#34;ssh_password&#34;</span>: <span style="color:#e6db74">&#34;vagrant&#34;</span>,
      <span style="color:#f92672">&#34;ssh_pty&#34;</span>: <span style="color:#66d9ef">true</span>,
      <span style="color:#f92672">&#34;shutdown_command&#34;</span>: <span style="color:#e6db74">&#34;sudo systemctl poweroff&#34;</span>,
      <span style="color:#f92672">&#34;vboxmanage&#34;</span>: [
        [<span style="color:#e6db74">&#34;modifyvm&#34;</span>, <span style="color:#e6db74">&#34;{{.Name}}&#34;</span>, <span style="color:#e6db74">&#34;--memory&#34;</span>, <span style="color:#e6db74">&#34;{{user `memory`}}&#34;</span>],
        [<span style="color:#e6db74">&#34;modifyvm&#34;</span>, <span style="color:#e6db74">&#34;{{.Name}}&#34;</span>, <span style="color:#e6db74">&#34;--cpus&#34;</span>, <span style="color:#e6db74">&#34;{{user `cpus`}}&#34;</span>],
        [<span style="color:#e6db74">&#34;modifyvm&#34;</span>, <span style="color:#e6db74">&#34;{{.Name}}&#34;</span>, <span style="color:#e6db74">&#34;--nic1&#34;</span>, <span style="color:#e6db74">&#34;nat&#34;</span>, <span style="color:#e6db74">&#34;--nictype1&#34;</span>, <span style="color:#e6db74">&#34;virtio&#34;</span>]
      ]
    }
  ],
  <span style="color:#f92672">&#34;provisioners&#34;</span>: [
    {
      <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;shell&#34;</span>,
      <span style="color:#f92672">&#34;scripts&#34;</span>: [
        <span style="color:#e6db74">&#34;scripts/sshd.sh&#34;</span>,
        <span style="color:#e6db74">&#34;scripts/virtualbox.sh&#34;</span>,
        <span style="color:#e6db74">&#34;scripts/cleanup.sh&#34;</span>
      ]
    }
  ],
  <span style="color:#f92672">&#34;post-processors&#34;</span>: [
    {
      <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;vagrant&#34;</span>,
      <span style="color:#f92672">&#34;compression_level&#34;</span>: <span style="color:#e6db74">&#34;{{user `compression_level`}}&#34;</span>,
      <span style="color:#f92672">&#34;output&#34;</span>: <span style="color:#e6db74">&#34;centos-7.7-x86_64-{{.Provider}}.box&#34;</span>
    }
  ],
  <span style="color:#f92672">&#34;variables&#34;</span>: {
    <span style="color:#f92672">&#34;compression_level&#34;</span>: <span style="color:#e6db74">&#34;6&#34;</span>,
    <span style="color:#f92672">&#34;cpus&#34;</span>: <span style="color:#e6db74">&#34;1&#34;</span>,
    <span style="color:#f92672">&#34;disk_size&#34;</span>: <span style="color:#e6db74">&#34;8000&#34;</span>,
    <span style="color:#f92672">&#34;hard_drive_discard&#34;</span>: <span style="color:#e6db74">&#34;true&#34;</span>,
    <span style="color:#f92672">&#34;hard_drive_interface&#34;</span>: <span style="color:#e6db74">&#34;sata&#34;</span>,
    <span style="color:#f92672">&#34;hard_drive_nonrotational&#34;</span>: <span style="color:#e6db74">&#34;true&#34;</span>,
    <span style="color:#f92672">&#34;headless&#34;</span>: <span style="color:#e6db74">&#34;true&#34;</span>,
    <span style="color:#f92672">&#34;iso_checksum&#34;</span>: <span style="color:#e6db74">&#34;6ffa7ad44e8716e4cd6a5c3a85ba5675a935fc0448c260f43b12311356ba85ad&#34;</span>,
    <span style="color:#f92672">&#34;iso_checksum_type&#34;</span>: <span style="color:#e6db74">&#34;sha256&#34;</span>,
    <span style="color:#f92672">&#34;memory&#34;</span>: <span style="color:#e6db74">&#34;512&#34;</span>,
    <span style="color:#f92672">&#34;mirror&#34;</span>: <span style="color:#e6db74">&#34;http://mirror.lug.udel.edu/pub/centos&#34;</span>,
    <span style="color:#f92672">&#34;ssh_timeout&#34;</span>: <span style="color:#e6db74">&#34;60m&#34;</span>
  }
}
</code></pre></div><p>{% endraw %}</p>
<p>Validate the contents of the json file <code>packer validate &lt;template&gt;</code>.</p>
<pre tabindex="0"><code class="language-console" data-lang="console">‚ûú  packer validate .\centos-7.7-x86_64.json
Template validated successfully.
</code></pre><h2 id="centos-kickstart-file">CentOS kickstart file</h2>
<p><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/installation_guide/sect-kickstart-syntax">Documentation</a> and <a href="https://github.com/CentOS/Community-Kickstarts">example</a> kickstart files can be found online. This file will install CentOS with configuration to fit my needs.</p>
<ul>
<li>Install a minimal set of packages</li>
<li>Disable firewall and SELinux</li>
<li>Add and configure the Vagrant user</li>
</ul>
<p><strong>Warning</strong>: Recommended for local development and lab use only. This kickstart file is insecure by default.
{: .flash .flash-warn }</p>
<pre tabindex="0"><code class="language-conf" data-lang="conf"># RHEL7 - Vagrant lab system
# Install OS instead of upgrade
install
# Keyboard layouts
keyboard 'us'
# After installation reboot
reboot
# Root password
rootpw --plaintext vagrant
# Use text mode install
text
firstboot --disable
# Setup network interface
network --device=eth0 --bootproto=dhcp --onboot=yes --activate
# Install from an installation tree on a remote server
# Required when using a miniml ISO
url --mirrorlist=http://mirrorlist.centos.org/?release=$releasever&amp;arch=$basearch&amp;repo=os
# Set repo to mirror.centos.org
repo --name=&quot;CentOS&quot; --baseurl=http://mirror.centos.org/centos/$releasever/os/$basearch/ --cost=100
repo --name=&quot;Updates&quot; --baseurl=http://mirror.centos.org/centos/$releasever/updates/$basearch/ --cost=100
repo --name=&quot;epel&quot; --baseurl=https://download.fedoraproject.org/pub/epel/7/x86_64/ --cost=100
# System language
lang en_US.UTF-8
# Logging
logging --level=debug
# System timezone
timezone --utc Etc/UTC
# Firewall
firewall --disable
# SELinux
selinux --permissive
# Accept EULA
eula --agreed
# Services
services --enabled=ntpd,ntpdate
# Add Vagrant user
user --name=vagrant --plaintext  --password=vagrant --groups=vagrant,wheel
# System bootloader configuration
bootloader --location=mbr
# Clear the Master Boot Record
zerombr
# Partition clearing information
clearpart --all --initlabel
# Automatically create partition, LVM
autopart --type=lvm

%packages --ignoremissing --excludedocs
@core
epel-release
dkms
kernel-devel
kernel-headers
make
automake
perl
gcc
gcc-c++
bzip2
which
wget
ntp
ntpdate
# mandatory packages in the @core group
-btrfs-progs
-iprutils
-kexec-tools
-plymouth
# default packages in the @core group
-*-firmware
-dracut-config-rescue
-kernel-tools
-libsysfs
-microcode_ctl
-NetworkManager*
-postfix
-rdma

%end

%post
# Apply Vagrant public key.
echo &quot;Applying Vagrant public key&quot;
sudo mkdir -p /home/vagrant/.ssh
sudo curl -fsSLo /home/vagrant/.ssh/authorized_keys https://raw.githubusercontent.com/hashicorp/vagrant/master/keys/vagrant.pub

# Change owner and group on SSH authorized keys file for vagrant user
sudo chown -R vagrant:vagrant /home/vagrant/.ssh
sudo chmod 700 /home/vagrant/.ssh
sudo chmod 600 /home/vagrant/.ssh/authorized_keys

# Configure Vagrant for no password sudo
echo &quot;Configuring Vagrant for passwordless sudo&quot;
sudo cat &gt; /etc/sudoers.d/vagrant &lt;&lt;'EOF'
Defaults:vagrant !requiretty
vagrant ALL=(ALL) NOPASSWD: ALL
EOF

# Change permissions on vagrant sudo file
sudo chmod 440 /etc/sudoers.d/vagrant
%end
</code></pre><h2 id="project-directory">Project directory</h2>
<p>The project directory should resemble the outline below.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">üì¶centos-packer-virtualbox
 ‚îÉ ‚î£ üìÇhttp
 ‚îÉ ‚îó üìúks.cfg
 ‚î£ üìÇscripts
 ‚îÉ ‚î£ üìúcleanup.sh
 ‚îÉ ‚î£ üìússhd.sh
 ‚îÉ ‚îó üìúvirtualbox.sh
 ‚î£ üìú.gitignore
 ‚îó üìúcentos-7.7-x86_64.json
</code></pre></div><h2 id="building-the-box">Building the box</h2>
<p>Once everything is in place run <code>packer build &lt;template&gt;</code>.</p>
<pre tabindex="0"><code class="language-console" data-lang="console">‚ûú  packer build centos-7.7-x86_64.json
virtualbox-iso output will be in this color.

...
truncated output
...

==&gt; virtualbox-iso: Running post-processor: vagrant
==&gt; virtualbox-iso (vagrant): Creating Vagrant box for 'virtualbox' provider
    virtualbox-iso (vagrant): Copying from artifact: output-centos-7.7-x86_64-virtualbox-iso\packer-centos-7.7-x86_64-disk001.vmdk
    virtualbox-iso (vagrant): Copying from artifact: output-centos-7.7-x86_64-virtualbox-iso\packer-centos-7.7-x86_64.ovf
    virtualbox-iso (vagrant): Renaming the OVF to box.ovf...
    virtualbox-iso (vagrant): Compressing: Vagrantfile
    virtualbox-iso (vagrant): Compressing: box.ovf
    virtualbox-iso (vagrant): Compressing: metadata.json
    virtualbox-iso (vagrant): Compressing: packer-centos-7.7-x86_64-disk001.vmdk
Build 'virtualbox-iso' finished.

==&gt; Builds finished. The artifacts of successful builds are:
--&gt; virtualbox-iso: 'virtualbox' provider box: centos-7.7-x86_64-virtualbox.box
</code></pre><h2 id="gitignore">.gitignore</h2>
<p>The <code>packer_cache</code> directory contains the ISO files used for building the image. The <code>*.box</code> file is the output image. These are large files that do not need to be tracked via Git. It&rsquo;s recommended to exclude these items in your <code>.gitignore</code> file.</p>
<pre tabindex="0"><code class="language-conf" data-lang="conf"># Cache objects
packer_cache/

# For built boxes
*.box
</code></pre>
    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Read other posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="/network-bonding/">
                  <span class="button__icon">‚Üê</span>
                  <span class="button__text">Network Bonding</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="/persistent-gnome-shell-in-lucid/">
                  <span class="button__text">Persistent Gnome shell in Lucid</span>
                  <span class="button__icon">‚Üí</span>
                </a>
              </span>
            
          </div>
        </div>
      
    

    
      
        

      
    
  </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >/misc/tech/musings</span
    >
    <span class="logo__cursor"></span>
  
</a>

      <div class="copyright">
        <span
          >¬© 2021 Powered by
          <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span
        >
        <span
          >Theme created by
          <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span
        >
      </div>
    
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
